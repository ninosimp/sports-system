<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="sidebar">
        <div class="brand">‚öΩ Sports Sys</div>
        <div class="menu">
            <a href="index.html">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="student.html">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</a>
            <a href="borrow.html">üìù ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
            <a href="return.html"class="active">‚Ü©Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</a>
            <a href="equipment.html">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
            <a href="history.html" >üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            <a href="fines.html">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</a>
            <a href="contact.html">üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
        </div>
        <button onclick="logout()" class="logout-btn-fixed">
    üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
</button>
    </div>

    <div class="content">
        <h1>‚Ü©Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</h1>
        <div class="card">
            <table>
                <thead><tr><th>ID</th><th>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th><th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        function loadList() {
            fetch(`${API_URL}/borrows/active`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('list');
                    const today = new Date().toISOString().split('T')[0]; // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ

                    tbody.innerHTML = data.map(r => {
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏´‡∏°
                        const isLate = r.DueDate < today;
                        const statusBadge = isLate 
                            ? `<span style="background:#fee2e2; color:#b91c1c; padding:4px 8px; border-radius:20px; font-weight:bold; font-size:0.8em;">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>` 
                            : `<span style="background:#dcfce7; color:#15803d; padding:4px 8px; border-radius:20px; font-weight:bold; font-size:0.8em;">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;

                        return `
                        <tr style="${isLate ? 'background-color:#fff1f2;' : ''}">
                            <td>#${r.BorrowID}</td>
                            <td>${r.StudentID}</td>
                            <td>${r.EquipName} (x${r.Qty})</td>
                            <td style="color:${isLate ? 'red' : 'black'}">${r.DueDate.split('T')[0]}</td>
                            <td>${statusBadge}</td>
                            <td><button class="btn-red" onclick="returnItem(${r.BorrowID})">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô</button></td>
                        </tr>`;
                    }).join('');
                });
        }

        async function returnItem(id) {
            // ‡πÉ‡∏ä‡πâ SweetAlert ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const { value: formValues } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
                html:
                    '<input id="swal-note" class="swal2-input" placeholder="‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏õ‡∏Å‡∏ï‡∏¥)">' +
                    '<input id="swal-fine" type="number" class="swal2-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" value="0">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    return {
                        note: document.getElementById('swal-note').value || '‡∏õ‡∏Å‡∏ï‡∏¥',
                        fine: document.getElementById('swal-fine').value || 0
                    }
                }
            });

            if (formValues) {
                try {
                    await fetch(`${API_URL}/return`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ BorrowID: id, ConditionNote: formValues.note, FineAmount: formValues.fine })
                    });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    loadList();
                } catch (err) {
                    Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        loadList();
    </script>
</body>
</html>