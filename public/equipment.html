<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="sidebar">
        <div class="brand">‚öΩ EquipmentHub</div>
        <div class="menu">
            <a href="index.html">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="student.html">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</a>
            <a href="borrow.html">üìù ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
            <a href="return.html">‚Ü©Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</a>
            <a href="equipment.html" class="active">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
            <a href="history.html">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            <a href="fines.html">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</a>
            <a href="contact.html">üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
        </div>
        <button onclick="logout()" class="logout-btn-fixed">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="content">
        <h1>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
        
        <div class="card">
            <h3 id="formTitle">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="addE" style="display:flex; gap:10px; align-items:flex-end;">
                <input type="hidden" id="editId"> <div style="flex:2;">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                    <input id="name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏•">
                </div>
                <div style="flex:1;">
                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="cat"><option>Balls</option><option>Rackets</option><option>General</option></select>
                </div>
                <div style="flex:1;">
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    <input type="number" id="qty" required placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
                </div>
                <button type="submit" id="btnSave" style="width:100px; margin-bottom:20px;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                <button type="button" id="btnCancel" onclick="cancelEdit()" style="width:100px; margin-bottom:20px; background:#6b7280; display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </form>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h3>
                <input type="text" id="searchBox" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="width:200px; margin:0;">
            </div>
            <table>
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="eList"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Security Check
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'login.html';
        function logout() {
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏≠‡∏≠‡∏Å' })
                .then((r) => { if(r.isConfirmed) { localStorage.removeItem('adminToken'); window.location.href='login.html'; } });
        }

        const API_URL = '/api';

        function loadE() {
            fetch(`${API_URL}/equipments`).then(r => r.json()).then(data => {
                const tbody = document.getElementById('eList');
                tbody.innerHTML = data.map(e => {
                    const isLow = e.AvailableQty < 5;
                    return `
                    <tr>
                        <td>${e.EquipName} <span style="color:gray; font-size:0.8em">(${e.Category})</span></td>
                        <td style="${isLow ? 'color:red; font-weight:bold;' : 'color:green'}">${e.AvailableQty} / ${e.Quantity} ${isLow ? '‚ö†Ô∏è' : ''}</td>
                        <td>${e.Status}</td>
                        <td>
                            <button onclick="editItem(${e.EquipID}, '${e.EquipName}', '${e.Category}', ${e.Quantity})" 
                                    style="background:#f59e0b; color:white; padding:5px 8px; border:none; border-radius:4px; cursor:pointer;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteItem(${e.EquipID})" 
                                    style="background:#ef4444; color:white; padding:5px 8px; border:none; border-radius:4px; cursor:pointer;">üóëÔ∏è ‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        window.editItem = (id, name, cat, qty) => {
            document.getElementById('editId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('cat').value = cat;
            document.getElementById('qty').value = qty;
            
            document.getElementById('formTitle').innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
            document.getElementById('btnSave').innerText = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
            document.getElementById('btnSave').style.backgroundColor = '#f59e0b'; // ‡∏™‡∏µ‡∏™‡πâ‡∏°
            document.getElementById('btnCancel').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        window.cancelEdit = () => {
            document.getElementById('addE').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').innerText = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('btnSave').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°';
            document.getElementById('btnSave').style.backgroundColor = '#3b82f6'; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById('btnCancel').style.display = 'none';
        }

        document.getElementById('addE').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const payload = {
                EquipName: document.getElementById('name').value,
                Category: document.getElementById('cat').value,
                Quantity: document.getElementById('qty').value
            };

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID = ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (PUT), ‡πÑ‡∏°‡πà‡∏°‡∏µ ID = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (POST)
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/equipments/${id}` : `${API_URL}/equipments`;

            try {
                const res = await fetch(url, {
                    method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const result = await res.json();
                
                if(res.ok) {
                    Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
                    cancelEdit(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°
                    loadE();
                } else {
                    Swal.fire('Error', result.message, 'error');
                }
            } catch (err) { Swal.fire('Error', '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error'); }
        });

        // ‡∏•‡∏ö
        window.deleteItem = (id) => {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
            }).then(async (r) => {
                if (r.isConfirmed) {
                    const res = await fetch(`${API_URL}/equipments/${id}`, { method: 'DELETE' });
                    const d = await res.json();
                    if(res.ok) { Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', d.message, 'success'); loadE(); }
                    else Swal.fire('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', d.message, 'error');
                }
            });
        }
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        document.getElementById('searchBox').addEventListener('keyup', function() {
            let val = this.value.toLowerCase();
            document.querySelectorAll('#eList tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
        });

        loadE();
    </script>
</body>
</html>