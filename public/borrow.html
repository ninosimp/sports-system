<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏° --- */
        .borrow-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Input Group) */
        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Å‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        .w-full { flex: 1; } /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
        .w-equip { flex: 4; } /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 4 ‡∏™‡πà‡∏ß‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown) */
        .w-qty { flex: 1; max-width: 100px; } /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 1 ‡∏™‡πà‡∏ß‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô) */
        .w-btn { flex: 0 0 auto; } /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° */

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå Input/Select */
        .form-control {
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            background-color: #fff;
            width: 100%;
            box-sizing: border-box; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏ß‡∏° padding ‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
            transition: border-color 0.2s;
        }
        .form-control:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° */
        .btn-add-item {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 12px 25px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            height: 48px; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤ input */
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .btn-add-item:hover { background-color: #059669; }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
        .cart-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .cart-table th {
            background-color: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .cart-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }
        .cart-table tr:last-child td { border-bottom: none; }
        
        .btn-del-row {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-del-row:hover { background-color: #fecaca; }

        /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô */
        .divider {
            margin: 25px 0;
            border: 0;
            border-top: 1px solid #e5e7eb;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà */
        .btn-confirm {
            width: 100%;
            margin-top: 25px;
            padding: 14px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
            transition: transform 0.1s;
        }
        .btn-confirm:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand">‚öΩ Sports Sys</div>
        <div class="menu">
            <a href="index.html">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="student.html">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</a>
            <a href="borrow.html" class="active">üìù ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
            <a href="return.html">‚Ü©Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</a>
            <a href="equipment.html">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
            <a href="history.html">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            <a href="fines.html">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</a>
            <a href="contact.html">üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
        </div>
        <button onclick="logout()" class="logout-btn-fixed">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="content">
        <h1>üìù ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
        
        <div class="card borrow-container">
            <div class="input-wrapper" style="margin-bottom: 15px;">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <select id="sid" class="form-control" required>
                    <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... --</option>
                </select>
                <small style="color:gray; font-size: 0.85rem;">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</small>
            </div>

            <div class="input-wrapper">
                <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</label>
                <input type="date" id="date" class="form-control" required>
            </div>

            <hr class="divider">

            <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </h3>
            
            <div class="input-group">
                <div class="input-wrapper w-equip">
                    <label>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                    <select id="equipSelect" class="form-control"></select>
                </div>
                <div class="input-wrapper w-qty">
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="qty" value="1" min="1" class="form-control">
                </div>
                <div class="input-wrapper w-btn">
                    <button type="button" class="btn-add-item" onclick="addToCart()">
                        <span>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
                    </button>
                </div>
            </div>

            <table class="cart-table">
                <thead>
                    <tr>
                        <th style="width: 60%;">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                        <th style="width: 20%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th style="width: 20%;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="cartBody">
                    </tbody>
            </table>

            <button class="btn-confirm" onclick="submitBorrow()">
                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
        </div>
    </div>

    <script>
        // Security Check
        if (!localStorage.getItem('adminToken')) window.location.href = 'login.html';
        function logout() {
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏≠‡∏≠‡∏Å', confirmButtonColor: '#d33' })
                .then((r) => { if(r.isConfirmed) { localStorage.removeItem('adminToken'); window.location.href='login.html'; } });
        }

        const API_URL = '/api';
        let cart = [];

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        fetch(`${API_URL}/students`).then(r=>r.json()).then(d=>{
            document.getElementById('sid').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>' + 
            d.map(s=>`<option value="${s.StudentID}">${s.StudentID} - ${s.FirstName} ${s.LastName}</option>`).join('');
        });

        fetch(`${API_URL}/equipments`).then(r=>r.json()).then(d=>{
            window.equipData = d;
            updateEquipSelect();
        });

        function updateEquipSelect() {
            const select = document.getElementById('equipSelect');
            if(window.equipData && window.equipData.length > 0) {
                select.innerHTML = window.equipData.map(e => 
                    `<option value="${e.EquipID}" ${e.AvailableQty==0?'disabled':''}>
                        ${e.EquipName} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${e.AvailableQty})
                    </option>`
                ).join('');
            } else {
                select.innerHTML = '<option>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>';
            }
        }

        function addToCart() {
            const equipID = document.getElementById('equipSelect').value;
            const qty = parseInt(document.getElementById('qty').value);
            
            if(!equipID) return;

            const equipObj = document.getElementById('equipSelect');
            const equipNameFull = equipObj.options[equipObj.selectedIndex].text;
            // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠...) ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const equipName = equipNameFull.split(' (')[0]; 

            const itemInDb = window.equipData.find(e => e.EquipID == equipID);
            const existingItem = cart.find(i => i.EquipID == equipID);
            const currentQtyInCart = existingItem ? existingItem.Qty : 0;

            if (qty + currentQtyInCart > itemInDb.AvailableQty) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠', text: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏Ñ‡πà ${itemInDb.AvailableQty} ‡∏ä‡∏¥‡πâ‡∏ô` });
                return;
            }

            if(existingItem) {
                existingItem.Qty += qty;
            } else {
                cart.push({ EquipID: equipID, EquipName: equipName, Qty: qty });
            }
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cartBody');
            if (cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 30px; color:#9ca3af;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>';
                return;
            }
            tbody.innerHTML = cart.map((item, index) => `
                <tr>
                    <td style="font-weight:500; color:#111827;">${item.EquipName}</td>
                    <td>${item.Qty}</td>
                    <td><button class="btn-del-row" onclick="removeFromCart(${index})">‡∏•‡∏ö‡∏≠‡∏≠‡∏Å</button></td>
                </tr>
            `).join('');
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        async function submitBorrow() {
            const sid = document.getElementById('sid').value;
            const date = document.getElementById('date').value;

            if (!sid || !date || cart.length === 0) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏¥‡πâ‡∏ô' });
                return;
            }

            const payload = { StudentID: sid, DueDate: date, Items: cart };

            try {
                const res = await fetch(`${API_URL}/borrow`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
                    cart = [];
                    renderCart();
                    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å
                    fetch(`${API_URL}/equipments`).then(r=>r.json()).then(d=>{ window.equipData=d; updateEquipSelect(); });
                } else {
                    Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            } catch (err) {
                Swal.fire('Error', '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
            }
        }
    </script>
</body>
</html>